var data=[];function add(a,g){0<$("#mdl_"+a.model_id).length||(data.push(a),findAllTargets(a,g))}
function findAllTargets(a,g,f){for(var b={},d=0,e=0;e<data.length;e++)for(var c=0;c<data[e].targets.length;c++)if(!b[data[e].targets[c].target_sequence]){for(var h=0;h<data.length;h++)for(var k=0;k<data[h].targets.length;k++)if(data[h].targets[k].target_sequence!=data[e].targets[c].target_sequence){var l=null,m=null;-1<data[h].targets[k].target_sequence.indexOf(data[e].targets[c].target_sequence)?(l=data[h].targets[k],m=data[e].targets[c]):-1<data[e].targets[c].target_sequence.indexOf(data[h].targets[k].target_sequence)&&
(l=data[e].targets[c],m=data[h].targets[k]);if(l){$("select option[target="+m.target_name+"]").attr("target",l.target_name);$("#target_"+m.target_name).closest("label").remove();var n=l.target_sequence.indexOf(m.target_sequence),p=l.target_sequence.length-m.target_sequence.length-n;m.target_sequence=l.target_sequence;m.target_name=l.target_name;for(l=0;l<m.chains.length;l++){for(var q=0;q<n;q++)m.chains[l].residues="-"+m.chains[l].residues,m.chains[l].res_num.unshift(null);for(q=0;q<p;q++)m.chains[l].residues+=
"-",m.chains[l].res_num.push(null)}}}b[data[e].targets[c].target_sequence]=data[e].targets[c].target_name;data[e].targets[c].target_name&&0==data[e].targets[c].target_name.indexOf("Target_")&&(d=Math.max(d,parseInt(data[e].targets[c].target_name.substring(7))))}(null==g||g)&&fetchFeatures(g);for(seq in b)null==b[seq]&&(b[seq]="Target_"+ ++d);for(e=0;e<data.length;e++)for(c=0;c<data[e].targets.length;c++)data[e].targets[c].target_name=b[data[e].targets[c].target_sequence];$("#clearComparisonBtn").show();
$("#nothingToSeeHere").hide();for(c=0;c<a.targets.length;c++)a.targets[c].target_name&&0==$("#target_"+a.targets[c].target_name).length&&($("#targetSelect").append('<label style="margin-right:32px;"><input onchange="selectTarget();" type="radio" name="compareby" id="target_'+a.targets[c].target_name+'" value="'+a.targets[c].target_name+'"'+(0==$("input[id^=target_]").length?' checked="checked"> ':"> ")+a.targets[c].target_name.replace("_"," ")+"</label>"),1<$("input[id^=target_]").length&&$("#targetSelect,#multipleTargets").show());
if(1==a.targets.length&&1==a.targets[0].chains.length)chains='<input type="hidden" id="select_'+a.model_id+'" value="'+a.targets[0].chains[0].id+'">'+a.targets[0].chains[0].id;else{chains='<select id="select_'+a.model_id+'" onchange="selectChain(this)">';for(c=0;c<a.targets.length;c++)for(b=0;b<a.targets[c].chains.length;b++)chains+='<option target="'+a.targets[c].target_name+'" value="'+a.targets[c].chains[b].id+'"',"smr"==a.source&&(chains+=' title="'+a.targets[c].chains[b].description+'"'),chains=
a.targets[c].chains[b].selected?chains+(" selected>"+a.targets[c].chains[b].id+"</option>"):chains+(">"+a.targets[c].chains[b].id+"</option>");chains+="</select>"}c="selection"+a.model_id.split("_")[0];switch(a.source){case "smr":c="selectionSMR";tblTitle="SWISS-MODEL Repository";break;case "swissmodel":tblTitle="SWISS-MODEL";break;case "qmean":tblTitle="QMEAN";break;case "assess":tblTitle="Structure Assessment"}0==$("#"+c).length&&$("#modelSelection").append('<div id="'+c+'"><p><i>From '+tblTitle+
(a.title?' - "'+a.title+'"':"")+'</i></p><table class="table table-condensed noborder"><tbody></tbody></table></div>');b="rgb(136,221,204) rgb(213,178,64) rgb(187,187,221) rgb(255,136,119) rgb(136,187,221) rgb(255,187,102) rgb(187,221,102) rgb(255,204,238) rgb(166,206,227) rgb(187,136,187) rgb(204,238,204) rgb(166,206,227)".split(" ");a.label||(a.label=1==data.length?"01":("00"+(parseInt(data[data.length-2].label)+1)).slice(-2));a.colour=b[(parseInt(a.label)-1)%b.length];$("#"+c).find("tbody").append('<tr id="mdl_'+
a.model_id+'"><td><span id="spLabel_'+a.model_id+'">  </span></td><td><button onclick="toggleHighlight(\''+a.model_id+'\');" style="font-weight:bold; color:'+a.colour+'" type=button class="btn btn-xs btn-primary" title="Toggle Transparency">'+a.label+'</button></td><td><button id="spBtn_'+a.model_id+'" class="btn btn-xs superposeBtn" title="Superpose on this"><i class="glyphicon glyphicon-align-center"></i></button></td><td><div id="range_'+a.model_id+'"></div></td><td nowrap="nowrap" id="nm_'+a.model_id+
'"></td><td>'+chains+'</td><td width="100%"><button class="btn btn-xs deleteBtn pull-right" style="color:#999;" title="Remove"><i class="glyphicon glyphicon-remove"></i></button></td></tr>');if(null==g||g)$("#superposeBtn").prop("disabled",!1),data||(data=[]),selectTarget(g),f||proposeConsensus()}
function proposeConsensus(){for(var a=[],g=[],f=0;f<data.length;f++)for(var b=0;b<data[f].targets.length;b++)for(var d=data[f].targets[b],e=0;e<data.length;e++)if(f!=e)for(var c=0;c<data[e].targets.length;c++){var h=data[e].targets[c];if(d.target_name!=h.target_name){for(var k=!1,l=null,m=0;m<a.length;m++)if(-1<a[m][0].indexOf(d.target_name)&&(l=a[m],-1<l[0].indexOf(h.target_name))){k=!0;break}if(!k&&d.target_sequence.length==h.target_sequence.length){for(m=k=0;m<d.target_sequence.length;m++)d.target_sequence.charAt(m)==
h.target_sequence.charAt(m)&&(k+=1);k=k/d.target_sequence.length*100;40<k&&(null==l&&(l=[[d.target_name],100],a.push(l)),l[0].push(h.target_name),l[1]=Math.min(l[1],k))}}}$("#targetMergeTable > body").html("");if(0!=a.length||0!=g.length){g="";for(f=0;f<a.length;f++)g+="<tr><td><i>",b=a[f][0].join(", "),g+=b+" are "+(2<a[f][0].length?"at least ":"")+a[f][1].toFixed(1)+'% identical.</i></td><td><button title="Combine targets '+b+' to consensus" class="consensusBtn btn btn-sm btn-default" targets="'+
b+'">Merge</button></td></tr>';$("#targetMergeTable").html(g);$("button.consensusBtn").on("click",mergeTrgs)}}
function mergeTrgs(a){$("#undoButton").text("Undo merge").show();$(this).closest("tr").remove();undoObject=JSON.parse(JSON.stringify(data));a=$(this).attr("targets").split(", ");for(var g=0;g<data.length;g++)for(var f=0;f<data[g].targets.length;f++)if(-1<a.indexOf(data[g].targets[f].target_name)){for(var b=9999999,d=0,e=0;e<data[g].targets[f].chains.length;e++){var c=data[g].targets[f].chains[e].residues.match(/[A-Z]/gi);b=Math.min(b,data[g].targets[f].chains[e].residues.indexOf(c[0]));d=Math.max(d,
data[g].targets[f].chains[e].residues.lastIndexOf(c[c.length-1]))}data[g].targets[f].target_sequence=data[g].targets[f].target_sequence.substring(b,d+1);for(e=0;e<data[g].targets[f].chains.length;e++)data[g].targets[f].chains[e].residues=data[g].targets[f].chains[e].residues.substring(b,d+1),data[g].targets[f].chains[e].res_num=data[g].targets[f].chains[e].res_num.slice(b,d+1)}targetToConsensus(a)}var undoObject;
function alignTrgs(){$("#undoButton").text("Undo alignment").show();undoObject=JSON.parse(JSON.stringify(data));console.time("align");for(var a=$(this).attr("targets").split(", "),g=[],f=[],b=0;b<a.length;b++){for(var d=9999999,e=0,c=0;c<data.length;c++)for(var h=0;h<data[c].targets.length;h++)if(data[c].targets[h].target_name==a[b])for(var k=0;k<data[c].targets[h].chains.length;k++){var l=data[c].targets[h].chains[k].residues.match(/[A-Z]/gi);d=Math.min(d,data[c].targets[h].chains[k].residues.indexOf(l[0]));
e=Math.max(e,data[c].targets[h].chains[k].residues.lastIndexOf(l[l.length-1]))}for(c=0;c<data.length;c++)for(h=0;h<data[c].targets.length;h++)if(data[c].targets[h].target_name==a[b]){data[c].targets[h].target_sequence=data[c].targets[h].target_sequence.substring(d,e+1);for(k=0;k<data[c].targets[h].chains.length;k++){if(data[c].targets[h].uniprot_name)if(data[c].targets[h].chains[k].up_num)data[c].targets[h].chains[k].up_num=data[c].targets[h].chains[k].up_num.slice(d,e);else for(data[c].targets[h].chains[k].up_num=
[],l=d;l<e;l++)data[c].targets[h].chains[k].up_num.push("-"==data[c].targets[h].chains[k].residues[l]?null:l);data[c].targets[h].chains[k].residues=data[c].targets[h].chains[k].residues.substring(d,e+1);data[c].targets[h].chains[k].res_num=data[c].targets[h].chains[k].res_num.slice(d,e+1)}0==b?g.push(data[c].targets[h]):f.push(data[c].targets[h])}}console.info(a);console.time("nw");al=nw(g[0].target_sequence,f[0].target_sequence);console.timeEnd("nw");for(s=0;2>s;s++)if(-1!=al[s].indexOf("-"))for(targets=
0==s?g:f,a=0;a<al[s].length;a++)if("-"==al[s].charAt(a))for(b=0;b<targets.length;b++)for(targets[b].target_sequence=0<b?targets[0].target_sequence:targets[b].target_sequence.substring(0,a+0)+"-"+targets[b].target_sequence.substring(a+0),d=0;d<targets[b].chains.length;d++)e=targets[b].chains[d],e.qmean&&e.qmean.splice(a+0,0,null),e.up_num&&e.up_num.splice(a+0,0,null),e.res_num.splice(a+0,0,null),e.residues=e.residues.substring(0,a+0)+"-"+e.residues.substring(a+0);targetToConsensus([g[0].target_name,
f[0].target_name]);$(this).closest("tr").remove();console.timeEnd("align")}
function targetToConsensus(a){console.time("cons");a||(a=$(this).attr("targets").split(", "));for(var g=null,f=9999,b=0,d=null,e=0;e<data.length;e++)for(var c=0;c<data[e].targets.length;c++){if(data[e].targets[c].target_name.startsWith("Consensus_")){var h=parseInt(data[e].targets[c].target_name.substring(10));f=Math.min(f,h);b=Math.max(b,h)}if(-1<a.indexOf(data[e].targets[c].target_name))if(data[e].targets[c].target_name=="Consensus_"+f&&(d="Consensus_"+f),null==g)g=data[e].targets[c].target_sequence;
else{h="";for(var k=0;k<g.length;k++)h=data[e].targets[c].target_sequence.charAt(k)==g.charAt(k)?h+g.charAt(k):"-"==data[e].targets[c].target_sequence.charAt(k)?h+g.charAt(k):"-"==g.charAt(k)?h+data[e].targets[c].target_sequence.charAt(k):h+"X";g=h}}d=d?d:"Consensus_"+(b+1);for(f=0;f<data.length;f++)for(b=0;b<data[f].targets.length;b++)-1<a.indexOf(data[f].targets[b].target_name)&&(data[f].targets[b].target_sequence=g,data[f].targets[b].target_name=d);$("#targetSelect,#modelSelection").empty();for(a=
0;a<data.length;a++)findAllTargets(data[a],a==data.length-1,!0);$(this).closest("tr").remove();console.timeEnd("cons")}function undo(){if(undoObject){data=undoObject;$("#targetSelect,#modelSelection").empty();for(var a=0;a<data.length;a++)findAllTargets(data[a],a==data.length-1,!0)}undoObject=null;$("#undoButton").hide()}
function removeModel(a,g){if(a){0==$("#mdl_"+a).siblings().length?$("#mdl_"+a).closest("div[id^=selection]").remove():$("#mdl_"+a).remove();for(var f={},b=0;b<data.length;b++)if(data[b].model_id==a)for(var d=0;d<data[b].targets.length;d++)f[data[b].targets[d].target_name]=!0;for(b=0;b<data.length;b++)if(data[b].model_id==a){data.splice(b,1);break}if(0<Object.keys(f).length){for(b=0;b<data.length;b++)for(d=0;d<data[b].targets.length;d++)f[data[b].targets[d].target_name]=!1;for(var e in f)f[e]&&$("#target_"+
e).closest("label").remove()}}else data=[],localStorage.removeItem("sequenceFeatures"),buildSeqFeatureSelector();g||localStorage.setItem("model",JSON.stringify(data));0==data.length?($("#modelSelection,#targetSelect,#consistency,#varianceMap").empty(),$("#multipleTargets,#consistencyTitle,#varianceTitle,#clearComparisonBtn").hide(),$("#nothingToSeeHere").show()):1==$("input[id^=target_]").length&&($(".invalidTarget").removeClass("invalidTarget").find("button,select").prop("disabled",!1),$("#targetSelect,#multipleTargets").hide());
0==$("input[id^=target_]:checked").length&&$("input[id^=target_]").first().prop("checked","checked");pv_viewer.rm(a?a+"*":"*");pv_viewer.requestRedraw();0<$("#ngl:visible",currentWin.document).length&&ngl_stage.eachComponent(function(c){a&&!c.name.startsWith(a)||ngl_stage.removeComponent(c)});$("#superposeBtn").prop("disabled",!1);selectTarget()}
function selectChain(a){$("#superposeBtn").prop("disabled",!1);var g=$(a).find("option:selected").val();a=$(a).attr("id").substring(7);for(var f=0;f<data.length;f++)if(data[f].model_id==a){for(var b=0;b<data[f].targets.length;b++)for(var d=0;d<data[f].targets[b].chains.length;d++)data[f].targets[b].chains[d].id==g&&($("#nm_"+data[f].model_id).text(data[f].targets[b].chains[d].name),$("input[id^=target_]:checked").val()!=data[f].targets[b].target_name?$("#mdl_"+data[f].model_id).addClass("invalidTarget"):
$("#mdl_"+data[f].model_id).removeClass("invalidTarget")),data[f].targets[b].chains[d].selected=data[f].targets[b].chains[d].id==g;drawRange(data[f]);break}drawAlignment();getVariance();selectResidues(g,null,a);buildSeqFeatureSelector()}
function selectTarget(a){$("#superposeBtn").prop("disabled",!1);$(".invalidTarget").removeClass("invalidTarget").find("button,select").prop("disabled",!1);var g=$("input[id^=target_]:checked").val();$("#modelSelection option[target="+g+"]").prop("disabled",!1);$("#modelSelection option").not("[target="+g+"]").prop("disabled","disabled");for(var f=0,b=0;b<data.length;b++){for(var d=!0,e=0;e<data[b].targets.length;e++)for(var c=0;c<data[b].targets[e].chains.length;c++)data[b].targets[e].target_name==
g&&0==c?(f++,d=!1,data[b].targets[e].chains[c].selected=!0,$("#nm_"+data[b].model_id).text(data[b].targets[e].chains[c].name),$("#select_"+data[b].model_id+' option[value="'+data[b].targets[e].chains[c].id+'"]').prop("selected","selected"),drawRange(data[b]),selectResidues(data[b].targets[e].chains[c].id,null,data[b].model_id,!0)):data[b].targets[e].chains[c].selected=!1;d&&$("#mdl_"+data[b].model_id).addClass("invalidTarget").find("button,select").prop("disabled","disabled")}2>f?$("#superposeBtn").hide():
$("#superposeBtn").show();drawAlignment();if(0<f){b=[];var h=[];if(0<$("#pv:visible",currentWin.document).length)pv_viewer.forEach(function(l){h.push(l.name())});else if(0<$("#ngl:visible",currentWin.document).length)for(d=0;d<ngl_stage.compList.length;d++)h.push(ngl_stage.compList[d].name);for(d=0;d<data.length;d++)for(e=0;e<data[d].targets.length;e++)if(data[d].targets[e].target_name==g){c=!1;for(var k=0;k<h.length;k++)if(h[k]==data[d].model_id){c=!0;break}c||b.push(data[d].model_id)}if(0<b.length)if(1<
f&&null!=a)superpose();else for(a=0;a<b.length;a++)loadModel(b[a])}buildSeqFeatureSelector();getVariance()}var defaultColour="consistency";$(document).one("click",".alignmentOptions input[name=csRadioGroup]",function(){defaultColour=null});
function drawAlignment(){var a=null;if(0<$(".superposeOnThisSeq").length){a={seqno:$(".superposeOnThisSeq").attr("seqno")};var g=$("#alignTblCompare span.selectResidue");0<g.length&&(a.from=g.first().index(),a.to=g.last().index())}if(0<$("#pv:visible",currentWin.document).length)pv_viewer.forEach(function(n){-1==n.name().indexOf("ligand")&&-1==n.name().indexOf("dna")&&n.colorBy(pv.color.uniform("lightgrey"))}),pv_viewer.requestRedraw();else if(null!=ngl_stage){g={};for(var f in ngl_stage.compList){g.$jscomp$loop$prop$strucId$38=
ngl_stage.compList[f].name;for(schemeId in NGL.ColormakerRegistry.userSchemes)-1<schemeId.indexOf(g.$jscomp$loop$prop$strucId$38)&&NGL.ColormakerRegistry.removeScheme(schemeId);ngl_stage.eachRepresentation(function(n){return function(p){if(p.name==n.$jscomp$loop$prop$strucId$38||p.name.endsWith(".highlight")){var q=NGL.ColormakerRegistry.addScheme(function(r){this.atomColor=function(t){return 16777215}},n.$jscomp$loop$prop$strucId$38);p.setColor(q)}}}(g));g={$jscomp$loop$prop$strucId$38:g.$jscomp$loop$prop$strucId$38}}}$("#superposeError").html("");
f=$("input[id^=target_]:checked").val();g=null;for(var b=0;b<data.length;b++)for(var d=0;d<data[b].targets.length;d++)if(data[b].targets[d].target_name==f){g=data[b].targets[d].target_sequence;break}var e=[],c=9999999,h=0;for(b=0;b<data.length;b++)for(d=0;d<data[b].targets.length;d++)for(var k=0;k<data[b].targets[d].chains.length;k++)if(data[b].targets[d].chains[k].selected){var l=data[b].targets[d].chains[k].residues.match(/[A-Z]/gi);c=Math.min(c,data[b].targets[d].chains[k].residues.indexOf(l[0]));
h=Math.max(h,data[b].targets[d].chains[k].residues.lastIndexOf(l[l.length-1]))}for(b=0;b<data.length;b++)for(l={consistency:[],qmean:[]},d=0;d<data[b].targets.length;d++)if(data[b].targets[d].target_sequence==g)for(k=0;k<data[b].targets[d].chains.length;k++){var m=data[b].targets[d].chains[k];if(m.selected){if(m.mean_lddt)for(k=0;k<m.mean_lddt.length;k++)null!=m.mean_lddt[k]&&(l.consistency[m.res_num[k+c]-1]=m.mean_lddt[k]);if(m.qmean)for(k=0;k<h+1;k++)l.qmean[m.res_num[k]-1]=m.qmean[k];e.push({trg_offset:c+
1,struc_id:data[b].model_id,qname:data[b].label+"."+m.id,selected:!0,chain:m.id,trg_seq:data[b].targets[d].target_sequence.substring(c,h+1),tpl_seq:m.residues.substring(c,h+1),pdb_res_num:m.res_num.slice(c,h+1),annotation:l});break}}0<e.length?($("#alignTblCompare").alignment({templateData:{target_name:f,type:"target-template",templates:e},nowrap:!0,resetColourCycle:!0,default_colour:defaultColour}),updatecols(),$("#alignTblCompare").data("offset",c)):$("#alignTblCompare tr,#alignNameTblCompare tr").remove();
a&&(f=$("tr[seqno="+a.seqno+"]").addClass("superposeOnThisSeq"),a.from&&f.find("span").slice(a.from,a.to+1).addClass("selectResidue"));setTransparency()}
function drawRange(a){width=95;height=18;$("#range_"+a.model_id).empty();var g=RegExp("-+","gi"),f;var b=0;var d=null;var e="";for(f=0;f<a.targets.length&&null==d;f++)for(var c=0;c<a.targets[f].chains.length;c++)if(a.targets[f].chains[c].selected){d=a.targets[f].chains[c].residues;a.targets[f].uniprot_name&&(e=" "+a.targets[f].uniprot_name);break}f=d.match(/[A-Z]/gi);for($("#range_"+a.model_id).attr("title",d.indexOf(f[0])+1+"-"+(d.lastIndexOf(f[f.length-1])+1)+e);f=g.exec(a.target_sequence);)d=d.substring(0,
f.index-b)+d.substring(g.lastIndex-b),b+=g.lastIndex-f.index;e=width/d.length;g=RegExp("[a-zA-Z]+","gi");b=Raphael("range_"+a.model_id,width,height);f=b.rect(1,1,width-2,height-2);f.attr({"stroke-width":.5,stroke:"#222",fill:"#FFF"});for(c=-1;f=g.exec(d);)-1==c&&(c=f.index+1),f=b.rect(e*f.index+1,1,e*(g.lastIndex-f.index),height-2),f.attr({"stroke-width":.4,stroke:"#EEE","stroke-opacity":.5,fill:"pdb"==a.provider?"seagreen":"rgba(30,90,255,.8)"})}$(window).on("storage",comparison_updated);
function comparison_updated(a){if("model"==a.originalEvent.key){var g=JSON.parse(a.originalEvent.newValue);if(g)if(g.length<data.length){a=[];for(var f=0;f<data.length;f++){for(var b=!0,d=0;d<g.length;d++)if(data[f].model_id==g[d].model_id){b=!1;break}b&&a.push(data[f].model_id)}for(g=0;g<a.length;g++)removeModel(a[g],!0)}else add(g[g.length-1])}}
$("body").on("highlightResidue",function(a,g){if("varianceChart"!=g.src&&($(".rowHighlight").removeClass("rowHighlight"),$("#mdl_"+g.struc_id).addClass("rowHighlight"),"structure"==g.src))for(var f=0;f<data.length;f++)if(data[f].model_id==g.struc_id){var b="";if("smr"==data[f].source)for(var d=0;d<data[f].targets.length;d++)for(var e=0;e<data[f].targets[d].chains.length;e++)data[f].targets[d].chains[e].id==g.chain&&(b=" ("+(data[f].targets[d].uniprot_name?data[f].targets[d].uniprot_name:data[f].targets[d].target_name)+
") ");d=0<$("#pv_status:visible").length?"pv_status":"ngl_status";$("#"+d).html("Model "+data[f].label+"; "+$("#"+d).html()+";"+b)}});
function setSuperposeOption(a,g,f){var b=$("#spBtn_"+a);b.blur();g&&b.hasClass("superposeOnThis")&&(b=null);$("button.superposeOnThis").removeClass("superposeOnThis");$("tr.superposeOnThisSeq").removeClass("superposeOnThisSeq");b&&(b.addClass("superposeOnThis"),a=$("#alignTblCompare tr[struc_id="+a+"]").attr("seqno"),$("tr[seqno="+a+"]").addClass("superposeOnThisSeq"),f||$("#superposeBtn").prop("disabled",!1))}
function toggleHighlight(a){var g=$("tr[id^=mdl_]");a=$("#mdl_"+a);a.hasClass("rowFade")?a.removeClass("rowFade"):0<$(".rowFade").length?1==g.not(".rowFade").length?g.removeClass("rowFade"):a.addClass("rowFade"):g.not(a).addClass("rowFade");setTransparency()}
function setTransparency(){$("tr[id^=mdl_]").each(function(){var a=$(this).attr("id").substring(4),g=$(this).hasClass("rowFade")?.3:1;0<$("#pv:visible",currentWin.document).length&&pv_viewer.forEach(function(f){0==f.name().indexOf(a)&&-1==f.name().indexOf("dna")&&(f.setOpacity(g),f.order(10-10*g))});0<$("#ngl:visible",currentWin.document).length&&ngl_stage.eachRepresentation(function(f){f.name.startsWith(a)&&f.repr.setParameters({opacity:g})})});0<$("#pv:visible",currentWin.document).length&&(pv_viewer._objects.sort(function(a,
g){return a.order()-g.order()}),pv_viewer.requestRedraw())}
$(document).ready(function(){showViewer($.cookie("defaultViewer")?$.cookie("defaultViewer"):"NGL",!0);if(localStorage.getItem("model"))for(var a=JSON.parse(localStorage.getItem("model")),g=0;g<a.length;g++)a[g].label=("00"+(g+1)).slice(-2),add(a[g],g==a.length-1);resize();$(document).scroll(resize);$(window).resize(resize);$("body").on("click","button.deleteBtn",function(f){f=$(f.target).closest("tr").attr("id").substring(4);removeModel(f)});$("body").on("click","button.superposeBtn",function(f){setSuperposeOption($(f.currentTarget).attr("id").substring(6),
!0)});$("body").on("click","#alignTblCompare tr",function(f){setSuperposeOption(f.currentTarget.getAttribute("struc_id"))})});
function resize(){if(751>$(window).width())$("#right-panel").css({position:"relative",left:"",top:"",width:""}),$("#viewerWrapper").height($("#viewerWrapper").width());else{var a=8,g=2*$("#sib_footer").height();"relative"==$("#right-panel").css("position")?$(document).scrollTop()>$("#left-panel").position().top-a-1?($("#viewerWrapper").height(window.innerHeight-$("#alignNowrap").innerHeight()-a-g),$("#right-panel").css({position:"fixed",top:a+"px",left:$("#left-panel").offset().left+$("#left-panel").outerWidth(),
width:$("#main-content").innerWidth()-$("#left-panel").outerWidth()})):(a=$("#right-panel").offset().top,$("#viewerWrapper").height(window.innerHeight-($("#alignNowrap").innerHeight()+a+g))):$(document).scrollTop()>$("#left-panel").position().top-a?($("#viewerWrapper").height(window.innerHeight-$("#alignNowrap").innerHeight()-a-g),$("#right-panel").css({position:"fixed",top:a+"px",left:$("#left-panel").offset().left+$("#left-panel").outerWidth(),width:$("#main-content").innerWidth()-$("#left-panel").outerWidth()})):
($("#right-panel").css({position:"relative",left:"",top:"",width:""}),a=$("#right-panel").offset().top,$("#viewerWrapper").height(window.innerHeight-($("#alignNowrap").innerHeight()+a+g)))}a=$("#varianceHeatmap").outerHeight(!0)-$("#varianceHeatmap").innerHeight();a=$("#left-panel").width()-a;$("#varianceHeatmap").height(a);$("#varianceHeatmap").width(a);0<$("#pv:visible",currentWin.document).length?pv_viewer.fitParent():null!=ngl_stage&&ngl_stage.handleResize()}
function showViewer(a,g){jQuery.cookie("defaultViewer",a,{expires:365,path:"/"});$("#pv_status,#ngl_status").text("");"PV"==a?($("#ngl,.notPV").hide(),$("#pv,.notNGL").show(),showPV()):"NGL"==a&&($("#pv,.notNGL").hide(),$("#ngl,.notPV").show(),showNGL());if(!g||1==data.length)for(var f=0;f<data.length;f++)loadModel(data[f].model_id)}function showPV(){pv_viewer.fitParent();pv_viewer._initialized&&pv_viewer.requestRedraw()}
function showNGL(){null==ngl_stage&&(ngl_stage=getNGL());ngl_stage.eachComponent(function(a){ngl_stage.removeComponent(a)});ngl_stage.handleResize()}function on_viewer_ready_function(){}var modelQueue=[];
function loadModel(a,g){if(!(-1<modelQueue.indexOf(a))){modelQueue.push(a);for(var f=comparisonURL.replace("00",a),b=0;b<data.length;b++)data[b].model_id==a&&data[b].transform&&(f+="?t="+data[b].transform.join(","));0<$("#pv:visible",currentWin.document).length&&loadModelPV(a,f,g);0<$("#ngl:visible",currentWin.document).length&&loadModelNGL(a,f,g)}}
function loadModelPV(a,g,f){pv_viewer.forEach(function(b){b.name()});pv.io.fetchPdb(g,function(b){if(b){var d=!0;b.eachAtom(function(c){if("CA"!=c.name()&&2<c.residue().name().length&&"_"!=c.residue().chain().name())return d=!1});var e=b.select("protein");mol.assignHelixSheet(e);if(d)pv_viewer.spheres(a,e);else switch($.cookie("defaultRepr")){case "trace":pv_viewer.trace(a,e,{color:pv.color.uniform([.8,.8,.8])});break;case "lines":pv_viewer.lines(a,e,{color:pv.color.uniform([.8,.8,.8])});break;case "tube":pv_viewer.tube(a,
e,{color:pv.color.uniform([.8,.8,.8])});break;default:pv_viewer.cartoon(a,e,{color:pv.color.uniform([.8,.8,.8])})}e=b.select({chain:"_"});40<e.residueCount()?pv_viewer.lines(a+".ligands",e):pv_viewer.ballsAndSticks(a+".ligands",e);b=b.select("ligand").select({rnames:"A C T G U DA DC DG DT".split(" ")});if(0<b.residueCount()){e=!1;if(2E3>b.residueCount())try{pv_viewer.cartoon(a+".dna",b,{color:new pv.color.ColorOp(function(c,h,k){switch(c._residue._name){case "T":case "DT":h[k+0]=.796875;h[k+1]=.72265625;
h[k+2]=.453125;break;case "C":case "DC":h[k+0]=.765625;h[k+1]=.3046875;h[k+2]=.3203125;break;case "A":case "DA":h[k+0]=.296875;h[k+1]=.4453125;h[k+2]=.6875;break;case "G":case "DG":h[k+0]=.33203125;h[k+1]=.65625;h[k+2]=.40625;break;case "U":h[k+0]=.5859375,h[k+1]=.29296875,h[k+2]=1/256}h[k+3]=1})}),e=!0}catch(c){}e||pv_viewer.lines(a+".dna",b)}f&&f.chains?f.struc_id==a&&centerResRangePV(f.chains[0],f.from,f.to,a):pv_viewer.autoZoom();pv_viewer.options("animateTime",1500);for(b=0;b<modelQueue.length;b++)modelQueue[b]===
a&&modelQueue.splice(b,1);0==modelQueue.length&&(updatecols(),setTransparency())}else{for(b=0;b<data.length;b++)data[b].model_id==a&&(e=data[b].label);$("#superposeError").html($("#superposeError").html()+"Model "+e+" could not be found!<br>")}})}
function loadModelNGL(a,g,f){ngl_stage.loadFile(g).then(function(b){setupNGLRepresentations(b,a,!1,["tube","base"]);f&&f.chains?f.struc_id==a&&centerResRangeNGL(f.chains[0],f.from,f.to,a):ngl_stage.autoView(1E3);setTransparency();for(b=0;b<modelQueue.length;b++)modelQueue[b]===a&&modelQueue.splice(b,1)})["catch"](function(){for(var b=0;b<data.length;b++);$("#superposeError").html($("#superposeError").html()+"Model "+data[b].label+" could not be found!<br>");for(b=0;b<modelQueue.length;b++)modelQueue[b]===
a&&modelQueue.splice(b,1)})}var spstart,varstart,superposeCount=0;
function superpose(){spstart=(new Date).getTime();var a=$("#alignTblCompare span.selectResidue");if(0<a.length&&3>a.length)$("#superposeError").html("Superposition requires at least 3 residues, you currently have  "+a.length+" column"+(1==a.length?"":"s")+" selected. <br>(Press Esc to clear)");else{var g=$(".superposeOnThis"),f=1==g.length?g.attr("id").substring(6):0,b=[];$("#modelSelection tbody>tr:not(.invalidTarget)").each(function(){var e=$(this).attr("id").substring(4);b.push({model_id:e,chain:$("#select_"+
e).is("select")?$("#select_"+e+" option:checked").val():$("#select_"+e).val(),ref_seq:e==f,residues:$("tr[struc_id="+e+"]").find("span").text()})});if(2>b.length)$("#superposeError").html("At least two structures required to superpose!");else{$("#superposeError").html("");$("#alignTblCompare, #alignNameTblCompare").find("tr[seqno=1]").hide();$("#alignTblCompare, #alignNameTblCompare").find("tr[seqno=1]").show();$("#superposeBtn").prop("disabled",!0);var d=++superposeCount;$.ajax({type:"POST",url:superposeURL,
data:{models:JSON.stringify(b),from:a.first().index(),to:a.last().index(),csrfmiddlewaretoken:csrf},dataType:"json",success:function(e){if(d==superposeCount){pv_viewer.rm("*");ngl_stage&&ngl_stage.eachComponent(function(u){ngl_stage.removeComponent(u)});for(var c=0,h=!1,k=0;k<data.length;k++)for(var l=0;l<e.results.superposed.length;l++)data[k].model_id==e.results.superposed[l].model_id&&(data[k].transform=e.results.superposed[l].transform);for(l=0;l<e.results.superposed.length;l++)if(k=e.results.superposed[l],
k.ref_idx){for(l=0;l<data.length&&!h;l++)if(data[l].model_id==k.model_id)for(var m=0;m<data[l].targets.length&&!h;m++)for(var n=0;n<data[l].targets[m].chains.length;n++)if(data[l].targets[m].chains[n].id==k.chain){for(var p=k.from+$("#alignTblCompare").data("offset"),q=k.to+$("#alignTblCompare").data("offset"),r=data[l].targets[m].chains[n].res_num[p],t=data[l].targets[m].chains[n].res_num[q];null==r&&p<data[l].targets[m].chains[n].res_num.length;)p++,r=data[l].targets[m].chains[n].res_num[p];for(;null==
t&&0<q;)q--,t=data[l].targets[m].chains[n].res_num[q];if(null==t||null==r)break;h={struc_id:k.model_id,chains:k.chain,from:r,to:t};break}setSuperposeOption(k.model_id,null,!0);break}for(k=0;k<e.results.superposed.length;k++)l=e.results.superposed[k],m=l.model_id,$("#spLabel_"+m).html(l.rmsd?" &#x2713; ":" &#x2717; "),l.rmsd||c++,loadModel(m,h);0<c&&$("#superposeError").html(c+" model"+(1<c?"s":"")+" failed to superpose!")}},error:function(e){var c=e.responseJSON;if(429==e.status)$("#superposeError").html("Too many requests - retry after "+
c.retryAfter+" s"),clearTimeout(this.id),this.id=setTimeout(function(){$("#superposeBtn").prop("disabled",!1);$("#superposeError").html("")},parseInt(1E3*c.retryAfter));else if(c){if(e=e.responseJSON.error,c.invalid){for(var h=0;h<c.invalid.length;h++)for(var k=0;k<data.length;k++)data[k].model_id==c.invalid[h]&&(e+="<br>Model "+data[k].label+" could not be found!");$("#superposeError").html(e)}}else $("#superposeError").html("Server error")}})}}}var varianceCount=0;
function getVariance(a){varstart=(new Date).getTime();varianceData=null;var g=[];$("#alignTblCompare span.selectResidue:first").index();$("#alignTblCompare span.selectResidue:last").index();$("#modelSelection tbody>tr:not(.invalidTarget)").each(function(){var d=$(this).attr("id").substring(4),e=$("tr[struc_id="+d+"]").find("span");g.push({model_id:d,chain:$("#select_"+d).is("select")?$("#select_"+d+" option:checked").val():$("#select_"+d).val(),residues:e.text(),first_resnum:e.filter("[s]:first").attr("s")})});
if(a)$("#exportModels").val(JSON.stringify(g)),$("#exportForm").attr("action","consistency"==a?consistencyDataURL:varianceDataURL),$("#exportForm").submit();else if($("#consistencyTitle, #varianceTitle").hide(),$("#consistency, #varianceMap").empty(),!(2>g.length)){$("#consistency, #varianceMap").html('<div style="width: 50px; margin: 0 auto;"><div class="loader"></div></div>');var f=800>g[0].residues.length?consistencyURL:consistencyNovarURL,b=++varianceCount;clearTimeout(this.id);this.id=setTimeout(function(){$.ajax({type:"POST",
url:f,data:{models:JSON.stringify(g),csrfmiddlewaretoken:csrf},dataType:"json",success:function(d){if(1<data.length&&b==varianceCount&&(drawVarianceMap(d.variance),drawConsistencyChart(d.consistency),(defaultColour||$.cookie("colourScheme")&&-1<$.cookie("colourScheme").indexOf("consistency"))&&drawAlignment(),d.invalid)){for(var e='<div class="error text-center">',c=0;c<d.invalid.length;c++)for(var h=0;h<data.length;h++)data[h].model_id==d.invalid[c]&&(e+="<br>Model "+data[h].label+" could not be found!");
$("#superposeError").html(e)}},error:function(d){var e=d.responseJSON,c='<div class="error text-center">Could not fetch variance data.<br>';if(429==d.status)c+="Too many requests - retry after "+e.retryAfter+" s",clearTimeout(this.id),this.id=setTimeout(function(){$("#consistency").html("")},parseInt(1E3*e.retryAfter));else if(e){if(c+=d.responseJSON.error,e.invalid){for(d=0;d<e.invalid.length;d++)for(var h=0;h<data.length;h++)data[h].model_id==e.invalid[d]&&(c+="<br>Model "+data[h].label+" could not be found!");
$("#consistency").html(c)}}else c+="Server error";$("#consistency").html(c+"</div>");$("#varianceMap").html("")}})},500)}}var varianceData=null;
function drawVarianceMap(a){if(a){if(a.error){$("#varianceMap").html('<div class="error text-center">Error fetching Variance data:<br>'+a.error+"</div>");return}varianceData=a.varmap;if(!a.image)return}$("#varianceTitle").show();$("#varianceMap").html(('<img id="varianceHeatmap" src="'+varimgURL+"?rnd="+(new Date).getTime()+'">').replace(/xxx\.png/,a.image));var g=($("#varianceHeatmap").outerHeight(!0)-$("#varianceHeatmap").innerHeight())/2;g=$("#left-panel").width()-2*g;$("#varianceHeatmap").height(g);
$("#varianceHeatmap").width(g);var f=a.length;$("#varianceMap img").bind("mousemove",function(b){var d=($("#varianceHeatmap").outerHeight(!0)-$("#varianceHeatmap").innerHeight())/2,e=$("#varianceHeatmap").width(),c=$(this).parent().offset(),h=b.pageX-c.left-d;c=b.pageY-c.top-d;h=Math.floor(f/e*h);c=f-1-Math.floor(f/e*c);h=Math.min(Math.max(h,0),f-1);c=Math.min(Math.max(c,0),f-1);e=h+$("#alignTblCompare").data("offset");b=c+$("#alignTblCompare").data("offset");d=varianceData&&varianceData[h][c]?varianceData[h][c]:
0;$("#varianceStatus").html("Residue Index: ["+e+","+b+"]; "+(varianceData?"Variation: "+varianceData[h][c].toFixed(2):"<i>Score disabled for large proteins</i>"));for(h=0;h<data.length;h++)$("body").trigger("highlightResidue",{src:"varianceChart",struc_id:data[h].model_id});c=[];for(h=0;h<data.length;h++)for(var k=0;k<data[h].targets.length;k++)for(var l=0;l<data[h].targets[k].chains.length;l++)data[h].targets[k].chains[l].selected&&data[h].targets[k].chains[l].res_num[e]&&data[h].targets[k].chains[l].res_num[b]&&
(c.push([{struc_id:data[h].model_id,chain:data[h].targets[k].chains[l].id,res_num:data[h].targets[k].chains[l].res_num[e]},{struc_id:data[h].model_id,chain:data[h].targets[k].chains[l].id,res_num:data[h].targets[k].chains[l].res_num[b]},d]),$("body").trigger("highlightResidue",{src:"varianceChart",struc_id:data[h].model_id,chain:data[h].targets[k].chains[l].id,resno:data[h].targets[k].chains[l].res_num[e],multiple:!0}),$("body").trigger("highlightResidue",{src:"varianceChart",struc_id:data[h].model_id,
chain:data[h].targets[k].chains[l].id,resno:data[h].targets[k].chains[l].res_num[b],multiple:!0}));$("body").trigger("connectResidues",{src:"consistencyChart",residuePairs:c})}).bind("mouseout",function(){$("#varianceStatus").text("");$("body").trigger("connectResidues",{src:"consistencyChart",residuePairs:null})})}
function drawConsistencyChart(a){$("#consistencyTitle").show();for(var g=[],f=99999,b=0;b<a.length;b++)for(var d=0;d<data.length;d++)if(data[d].model_id==a[b].model_id)for(var e=0;e<data[d].targets.length;e++)for(var c=0;c<data[d].targets[e].chains.length;c++)if(data[d].targets[e].chains[c].id==a[b].chain){data[d].targets[e].chains[c].mean_lddt=a[b].mean_lddt;var h=data[d].targets[e].chains[c].residues.match(/[A-Z]/gi);f=Math.min(f,data[d].targets[e].chains[c].residues.indexOf(h[0]))}for(b=0;b<a.length;b++)for(d=
0;d<data.length;d++)if(data[d].model_id==a[b].model_id)for(e=0;e<data[d].targets.length;e++)for(c=0;c<data[d].targets[e].chains.length;c++)data[d].targets[e].chains[c].id==a[b].chain&&g.push({name:data[d].label,data:[null].concat(data[d].targets[e].chains[c].mean_lddt),res_num:data[d].targets[e].chains[c].res_num.slice(f),model_id:data[d].model_id,chain:data[d].targets[e].chains[c].id,color:data[d].colour,point:{events:{mouseOver:function(){$("body").trigger("highlightResidue",{src:"consistencyChart",
struc_id:this.series.options.model_id,chain:this.series.options.chain,resno:this.series.options.res_num[this.x-1]})}}}});Highcharts.chart("consistency",{chart:{type:"line",zoomType:"x",spacingBottom:0},title:null,plotOptions:{series:{lineWidth:1}},legend:{margin:4,padding:0},xAxis:{title:{text:"Residue index",offset:22}},yAxis:{title:{text:"Consistency"},max:1,min:0},credits:{enabled:!1},tooltip:{formatter:function(){return this.series.name+"<br>Residue: "+this.series.options.res_num[this.point.x-
1]+" <br>Consistency: <b>"+this.point.y.toFixed(2)+"</b>"}},series:g})}
$("#molprobityTable").on("click","input[type=checkbox]",function(a){a=$(this).prop("checked");$(this).hasClass("mpCatCB")?$(this).closest("td").siblings().find("input[type=checkbox]").prop("checked",a):a||0==$(this).closest("td").find("input[type=checkbox]:checked").length&&$(this).closest("td").siblings().find("input").prop("checked",!1);var g={};$("#molprobityTable input[type=checkbox]:checked").not(".mpCatCB").each(function(){var h=$(this).attr("id");$("span[id^="+h+"]").each(function(){var k=
$(this).attr("id").match(/[a-z]+((_[a-z]+)+)?/g)[0],l=$(this).attr("id").substring(k.length+1).split("_").map(Number),m=data[l[0]].targets[l[1]].chains[l[2]];k=m.outliers[k][l[3]];data[l[0]].model_id in g||(g[data[l[0]].model_id]=[]);g[data[l[0]].model_id].push({toChn:m.id,frmChn:m.id,resStart:k[0],resEnd:k[0],rgb:"240,40,40"});2<k.length&&g[data[l[0]].model_id].push({toChn:m.id,frmChn:m.id,resStart:k[1],resEnd:k[1],rgb:"240,40,40"})})});0<Object.keys(g).length?$(".alignTbl").alignment("colourAlignment",
{features:g}):(resetStructure(),$(".alignTbl").alignment("colourAlignment",{}));for(struc_id in g){a={};var f=!1,b=g[struc_id];if(0<b.length){for(var d=0;d<b.length;d++)b[d].frmChn==b[d].toChn&&(null==a[b[d].frmChn]&&(a[b[d].frmChn]=[]),a[b[d].frmChn].push([b[d].resStart,b[d].resEnd]),5<b[d].resEnd-b[d].resStart&&(f=!0));if(0<$("#pv:visible",currentWin.document).length){var e=[];for(chn in a){var c=selectResidues(chn,a[chn],struc_id,!0);c.eachResidue(function(h){e.push(h.chain().name());e.push(h.num())})}0<
c.residueCount()&&(f&&selectResidues(null,null,struc_id),b=pv_viewer.get(struc_id).structure().residueSelect(function(h){for(var k=0;k<e.length;k+=2)if(h.chain().name()==e[k]&&h.num()==e[k+1])return!0;return!1}),pv_viewer.fitTo(b));pv_viewer.requestRedraw()}if(0<$("#ngl:visible",currentWin.document).length){selectResidues(null,null,struc_id);b="";for(chn in a)b=selectResidues(chn,a[chn],struc_id,!0);f&&selectResidues(null,null,struc_id);ngl_stage.getComponentsByName(struc_id).list[0].autoView(b,1E3)}}}});
$("#molprobityTable").on("mouseover","span",function(){var a=$(this).attr("id").match(/[a-z]+((_[a-z]+)+)?/g)[0],g=$(this).attr("id").substring(a.length+1).split("_").map(Number),f=data[g[0]].targets[g[1]].chains[g[2]],b=f.outliers[a][g[3]],d=null;"clashes"==a&&4==b.length&&(d=b[3]);$("body").trigger("highlightResidue",{src:"outlier",struc_id:data[g[0]].model_id,chain:f.id,resno:b[0]});(d||2<b.length)&&$("body").trigger("highlightResidue",{src:"outlier",struc_id:data[g[0]].model_id,chain:d?d:f.id,
resno:b[1],multiple:!0})}).on("click","span",function(){var a=$(this).attr("id").match(/[a-z]+((_[a-z]+)+)?/g)[0],g=$(this).attr("id").substring(a.length+1).split("_").map(Number),f=data[g[0]].targets[g[1]].chains[g[2]],b=f.outliers[a][g[3]],d=null;"clashes"==a&&4==b.length&&(d=b[3]);$("body").trigger("centerResRange",{src:"outlier",struc_id:data[g[0]].model_id,chain:f.id,secondChain:d,min:b[0],max:d||2<b.length?b[1]:b[0]})});
function buildStrucFeatureSelector(){var a=!1;$("#molprobityTable tr").hide();$("#molprobityTable td[id^=outlier]").html("");for(var g=0;g<data.length;g++)if("assess"==data[g].source)for(var f=0;f<data[g].targets.length;f++)for(var b=0;b<data[g].targets[f].chains.length;b++)if(data[g].targets[f].chains[b].selected){var d=data[g].targets[f].chains[b].outliers;for(key in d){(a=$("#outliers_"+key).html())&&0<a.length&&(a+="<br>");a+='<label class="checkbox-inline"><input class="checkbox" type="checkbox" id="'+
key+"_"+g+"_"+f+'">'+data[g].label+"</label> : ";for(var e=0;e<d[key].length;e++){var c="clashes"==key&&4==d[key][e].length;a+=(0<e?", ":"")+'<span title="'+(c?d[key][e][2]:d[key][e][d[key][e].length-1])+'" id="'+key+"_"+g+"_"+f+"_"+b+"_"+e+'"> '+d[key][e][0];c?a+="-"+d[key][e][3]+d[key][e][1]:2<d[key][e].length&&(a+="-"+d[key][e][1]);a+="</span>"}$("#molprobityContainer").show();$("#outliers_"+key).html(a).closest("tr").show();a=!0}}return a}var activeFeatures=null;
function buildSeqFeatureSelector(){activeFeatures=[];$("#sequenceFeaturesContainer,#molprobityContainer,#nofeatures").hide();$("#allFeaturesTable > body").html("");$("#featureSelector").html("");var a=buildStrucFeatureSelector(),g=$("input[name=compareby]:checked");if(0==g.length)a||$("#nofeatures").show();else{var f=JSON.parse(localStorage.getItem("sequenceFeatures"));g=[g.val()];if(g[0].startsWith("Consensus"))for(var b=g.pop(),d=0;d<data.length;d++)for(var e=0;e<data[d].targets.length;e++)data[d].targets[e].target_name==
b&&data[d].targets[e].uniprot_name&&-1==g.indexOf(data[d].targets[e].uniprot_name)&&g.push(data[d].targets[e].uniprot_name);else{b=null;for(d=0;d<data.length;d++)for(e=0;e<data[d].targets.length;e++)if(data[d].targets[e].target_name==g[0]){b=data[d].targets[e].target_sequence;break}for(d=0;d<data.length;d++)for(e=0;e<data[d].targets.length;e++)data[d].targets[e].target_sequence==b&&data[d].targets[e].uniprot_name&&-1==g.indexOf(data[d].targets[e].uniprot_name)&&g.push(data[d].targets[e].uniprot_name)}d=
b=!1;if(f)for(e=0;e<g.length;e++)null!=f[g[e]]&&("fetching"==f[g[e]]&&(d=!0),b=!0);if("fetching"!=d)if(b){a={USERANNOT:"User Annotations",ACT_SITE:"Active site",CA_BIND:"Calcium binding",DISULFID:"Disulfide bond",DNA_BIND:"DNA binding",INTERPRO:"InterPro",INTRAMEM:"Intramembrane",METAL:"Metal binding",MOD_RES:"Modified residue",MOTIF:"Motif",NP_BIND:"Nucleotide binding",SITE:"Site",TRANSMEM:"Transmembrane",VARIANT:"Natural variant",ZN_FING:"Zinc finger",RESISTANCE:"Resistance-associated variant"};
b="";d=[];e="";for(var c=$("#alignTblCompare").data("offset"),h=$("#alignTblCompare tr[seqno=1] span[s]:last").attr("s"),k=0;k<g.length;k++){var l=f[g[k]];if(l){1<g.length&&(b+='<tr><td colspan=3><div style="margin-top:8px; text-align:center">Features for <b>'+g[k]+"</b></div></td></tr>");for(var m=0;m<l.length;m++){var n=l[m];"CHAIN"==n.type||n.end<c||n.start>h||(n.uniprot_name=g[k],activeFeatures.push(n),-1==d.indexOf(n.type)&&(e+='<button class="btn btn-sm btn-default feature-button '+n.type+'" ftype="'+
n.type+'" style="background-image:none;" type="button">'+a[n.type]+"</button>",d.push(n.type)),b+='<tr class="row_'+n.type+'"><td '+(n.col?'style="background-color:rgb('+n.col+")":'class="'+n.type)+'">&nbsp;</td><td nowrap="nowrap"><a id="ft_'+(activeFeatures.length-1)+'" href="#">'+n.start+(n.start==n.end?"":"-"+n.end)+"</a></td>",n.ref?(b+="<td>",b=n.ref[0]?b+('<a href="'+n.ref[0]+'" target="_blank"><span class="glyphicon glyphicon-new-window"></span></a>'):n.ref&&!n.ref[0]?b+('<span class="glyphicon glyphicon-info-sign" title="'+
n.ref[1]+'" data-toggle="tooltip"></span>'):b+"-",b+="</td><td>"):b+='<td colspan="2">',n.desc&&(b+=n.desc),"INTERPRO"==n.type&&(b+='<br><a target="_blank" href="https://www.ebi.ac.uk/interpro/entry/'+n.interpro+'">'+n.interpro+'<i class="glyphicon glyphicon-new-window" style="opacity:0.5; font-size:.6em; vertical-align:text-top; margin-left:2px; margin-right:4px"></i></a> <a target="_blank" href="https://pfam.xfam.org/family/'+n.pfam+'">'+n.pfam+'<i class="glyphicon glyphicon-new-window" style="opacity:0.5; font-size:.6em; vertical-align:text-top; margin-left:2px"></i></a>'),
n.ftid&&(b="->"==n.desc.substring(2,4)?b+('<a target="_blank" href="https://web.expasy.org/variant_pages/VAR_'+n.ftid+'.html">VAR_'+n.ftid+'<i class="glyphicon glyphicon-new-window" style="opacity:0.5; font-size:.6em; vertical-align:text-top; margin-left:2px"></i></a>'):b+(" VAR_"+n.ftid)),n.dbsnp&&(b+=' <a target="_blank" href="https://www.ncbi.nlm.nih.gov/SNP/snp_ref.cgi?type='+n.dbsnp.substring(0,2)+"&"+n.dbsnp.substring(0,2)+"="+n.dbsnp.substring(2)+'"> dbSNP<i class="glyphicon glyphicon-new-window" style="opacity:0.5; font-size:.6em; vertical-align:text-top; margin-left:2px"></i></a>'),
$("#featureSelector").html(e),b+="</td></tr>")}}}0==activeFeatures.length&&$("#featureSelector").html("No sequence features found for the ranges covered by the selected chains.");$("#allFeaturesTable > tbody").html(b);$("#sequenceFeaturesContainer").show()}else a||$("#nofeatures").show()}}
function fetchFeatures(a){var g=JSON.parse(localStorage.getItem("sequenceFeatures"));null==g&&(g={});for(var f=[],b=0;b<data.length;b++)for(var d=0;d<data[b].targets.length;d++){var e=data[b].targets[d].uniprot_name;!e||-1<f.indexOf(e)||(!a||g[e]&&"fetching"!=g[e])&&(-1!=f.indexOf(e)||null!=g[e])||(f.push(e),g[e]="fetching")}0!=f.length&&(localStorage.setItem("sequenceFeatures",JSON.stringify(g)),$.ajax({type:"POST",url:featuresURL,data:{ids:f.join(","),csrfmiddlewaretoken:csrf},dataType:"json",success:function(c){var h=
JSON.parse(localStorage.getItem("sequenceFeatures"));for(key in c)h[key]=c[key];localStorage.setItem("sequenceFeatures",JSON.stringify(h));buildSeqFeatureSelector()},error:function(c){c&&c.responseJSON&&$("#allFeatures").html(c.responseJSON.error);console.error("Server error fetching features");localStorage.removeItem("sequenceFeatures")}}))}$("a[id^=features_]").css("visibility","visible").popover({html:!0,placement:"top",content:function(){return $("#allFeatures").clone(!0)},container:"#viewerSettings"});
$("body").on("click",function(a){$("a[id^=features_]").each(function(){$(this).is(a.target)||0!==$(this).has(a.target).length||0!==$(".popover").has(a.target).length||((($(this).popover("hide").data("bs.popover")||{}).inState||{}).click=!1)})});
$("#allFeatures").on("click",".feature-button",function(){if($(this).hasClass("active"))showRanges([],!0),$(".alignTbl").alignment("colourAlignment",{});else{$(".active").removeClass("active");$(this).addClass("active");for(var a=[],g=0;g<activeFeatures.length;g++)activeFeatures[g].type==$(this).attr("ftype")&&a.push(activeFeatures[g]);showFeatures(a)}});
$("#allFeatures").on("click","a[id^=ft]",function(){var a=$(this).parents("tr");a.hasClass("active")?(showRanges([],!0),$(".alignTbl").alignment("colourAlignment",{})):($(".active").removeClass("active"),a.addClass("active"),showFeatures([activeFeatures[parseInt($(this).attr("id").substring(3))]]));return!1});
function showFeatures(a){for(var g=a.col?null:$("button."+a[0].type).css("background-color").match(/\d+/g).slice(0,3).join(","),f={},b=0;b<data.length;b++)for(var d=0;d<data[b].targets.length;d++)for(var e=0;e<data[b].targets[d].chains.length;e++){var c=data[b].targets[d].chains[e];if(c.selected){f[data[b].model_id]=[];for(var h=0;h<a.length;h++)if(!data[b].targets[d].uniprot_name||a[h].uniprot_name==data[b].targets[d].uniprot_name){var k=a[h].col?a[h].col:g,l=a[h].start-1,m=a[h].end-1;if(!data[b].targets[d].uniprot_name){var n=
!1;for(x=0;x<data.length&&!n;x++)for(tt=0;tt<data[x].targets.length&&!n;tt++)if(data[x].targets[tt].uniprot_name&&a[h].uniprot_name==data[x].targets[tt].uniprot_name)for(var p=0;p<data[x].targets[tt].chains.length&&!n;p++)if(data[x].targets[tt].chains[p].selected&&data[x].targets[tt].chains[p].up_num){n=data[x].targets[tt].chains[p].up_num;l=n.indexOf(l);m=n.indexOf(m);if(!l&&"DISULFID"!=a[h].type)for(var q=0;q<n.length;q++)if(null!=n[q]&&n[q]>=l&&n[q]<=m){l=q;break}if(!m&&"DISULFID"!=a[h].type)for(q=
n.length;0<q;q--)if(null!=n[q]&&n[q]<=m&&n[q]>=l){m=q;break}n=!0}k=k.split(",").map(function(r){r=parseInt(r);return 40<r?r-40:r+40}).join(",")}else if(c.up_num){l=c.up_num.indexOf(l);m=c.up_num.indexOf(m);if(-1==l&&"DISULFID"!=a[h].type)for(p=0;p<c.up_num.length;p++)if(null!=c.up_num[p]&&c.up_num[p]>=a[h].start-1&&c.up_num[p]<=a[h].end-1){l=p;break}if(-1==m&&"DISULFID"!=a[h].type)for(p=c.up_num.length;0<p;p--)if(null!=c.up_num[p]&&c.up_num[p]<=a[h].end-1&&c.up_num[p]>=a[h].start-1){m=p;break}}p=
c.res_num[l];n=c.res_num[m];if("DISULFID"!=a[h].type){for(;null==p&&l<m;)l+=1,p=c.res_num[l];for(;null==n&&m>l;)--m,n=c.res_num[m]}p&&n&&("DISULFID"==a[h].type?(f[data[b].model_id].push({toChn:c.id,frmChn:c.id,upStart:l,upEnd:l,resStart:p,resEnd:p,rgb:k,isDisulfid:!0}),f[data[b].model_id].push({toChn:c.id,frmChn:c.id,upStart:m,upEnd:m,resStart:n,resEnd:n,rgb:k,isDulsfid:!0})):f[data[b].model_id].push({toChn:c.id,frmChn:c.id,upStart:l,upEnd:m,resStart:p,resEnd:n,rgb:k,isDisulfid:!1}))}0==f[data[b].model_id].length&&
delete f[data[b].model_id]}}showRanges(f)}
function showRanges(a,g){0==a.length&&$(".active").removeClass("active");g||$(".alignTbl").alignment("colourAlignment",{features:a});var f={},b=!1,d=!1;for(struc_id in a)if(selectResidues(null,null,struc_id),0<a[struc_id].length){for(var e=0;e<a[struc_id].length;e++){var c=a[struc_id][e];c.frmChn==c.toChn&&(null==f[c.frmChn]&&(f[c.frmChn]=[]),c.isDisulfid?(f[c.frmChn].push([c.resStart,c.resStart]),f[c.toChn].push([c.resEnd,c.resEnd])):(f[c.frmChn].push([c.resStart,c.resEnd]),5<c.resEnd-c.resStart&&
(d=!0)))}if(0<$("#pv:visible",currentWin.document).length&&pv_viewer._initialized){var h=[];e=[];for(chn in f)e=selectResidues(chn,f[chn],struc_id,!0),e.eachResidue(function(t){h.push(t.chain().name());h.push(t.num())});0<e.residueCount()&&(b=!0,d&&selectResidues(null,null,struc_id),e=pv_viewer.get(struc_id).structure().residueSelect(function(t){for(var u=0;u<h.length;u+=2)if(t.chain().name()==h[u]&&t.num()==h[u+1])return!0;return!1}),pv_viewer.fitTo(e));pv_viewer.requestRedraw()}if(0<$("#ngl:visible",
currentWin.document).length){c=[];for(chn in f)for(e=0;e<chn.length;e++)for(var k=chn[e],l=f[chn],m=0;m<l.length;m++)for(var n=l[m],p=n[0];p<=n[1];p++)c.push(k+p);clNGLSelection=contactListToNGLSelection(struc_id,c)[0];""!=clNGLSelection&&(b=!0);if(!d)for(var q in ngl_stage.compList)if(ngl_stage.compList[q].name==struc_id){for(var r in ngl_stage.compList[q].reprList)ngl_stage.compList[q].reprList[r].name==struc_id+".residuesHighlight"&&ngl_stage.compList[q].reprList[r].setSelection(clNGLSelection);
break}ngl_stage.getComponentsByName(struc_id).list[0].autoView(clNGLSelection,1E3)}}$("#pv_status,#ngl_status",currentWin.document).html("");b||$("#pv_status:visible,#ngl_status:visible",currentWin.document).html('<span style="font-weight:bold;font-size:1.2em;">This structure is missing residues at this feature location!</span>')}
function showExample(a){$("#exampleError").html("");$.ajax({type:"POST",url:exampleURL.replace("xxx",a),data:{csrfmiddlewaretoken:csrf},dataType:"json",success:function(g){localStorage.setItem("model",JSON.stringify(g.example));for(var f=0;f<g.example.length;f++)g.example[f].label=("00"+(f+1)).slice(-2),add(g.example[f],f==g.example.length-1);selectTarget(!0);resize()},error:function(g){g.responseJSON?$("#exampleError").html("Problem with example: "+g.responseJSON.error):$("#exampleError").html("Server error")}})}
var UP=1,LEFT=2,UL=4;
function nw(a,g,f){f=f||{};var b=f.G||2,d=f.P||10,e=f.M||-1,c={};f={};console.time("i");for(var h=0;h<a.length+1;h++){c[h]={0:0};f[h]={0:[]};for(var k=1;k<g.length+1;k++)c[h][k]=0==h?0:a.charAt(h-1)==g.charAt(k-1)?d:e,f[h][k]=[]}console.timeEnd("i");console.time("v");for(h=0;h<a.length+1;h++)for(k=0;k<g.length+1;k++)d=0==h||0==k?-b*(h+k):Math.max(c[h-1][k]-b,c[h-1][k-1]+c[h][k],c[h][k-1]-b),0<h&&0<k?(d==c[h-1][k]-b&&f[h][k].push(UP),d==c[h][k-1]-b&&f[h][k].push(LEFT),d==c[h-1][k-1]+c[h][k]&&f[h][k].push(UL)):
f[h][k].push(0==k?UP:LEFT),c[h][k]=d;console.timeEnd("v");console.time("r");b=[[],[]];d=a.length;for(c=g.length;0<d||0<c;)switch(f[d][c][0]){case UP:d--;b[0].push(a.charAt(d));b[1].push("-");break;case LEFT:c--;b[0].push("-");b[1].push(g.charAt(c));break;case UL:d--,c--,b[0].push(a.charAt(d)),b[1].push(g.charAt(c))}console.timeEnd("r");return b.map(function(l){return l.reverse().join("")})};